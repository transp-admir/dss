{% extends "base_adm.html" %}

{% block title %}Relatórios Consolidados de Checklists{% endblock %}

{% block header %}Relatórios Consolidados de Checklists{% endblock %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5 class="mb-0">Filtrar Relatórios</h5>
    </div>
    <div class="card-body">
        <form method="POST" id="filtro-form">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="tipo_checklist" class="form-label">Tipo de Checklist</label>
                    <select class="form-select" id="tipo_checklist" name="tipo_checklist">
                        <option value="">Todos</option>
                        <option value="DIÁRIO" {% if filtros.get('tipo_checklist') == 'DIÁRIO' %}selected{% endif %}>DIÁRIO</option>
                        <option value="SEMANAL" {% if filtros.get('tipo_checklist') == 'SEMANAL' %}selected{% endif %}>SEMANAL</option>
                        <option value="MENSAL" {% if filtros.get('tipo_checklist') == 'MENSAL' %}selected{% endif %}>MENSAL</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="veiculo_id" class="form-label">Veículo</label>
                    <select class="form-select" id="veiculo_id" name="veiculo_id">
                        <option value="todos">Todos os Veículos</option>
                        {% for v in veiculos %}
                            <option value="{{ v.id }}" {% if filtros.get('veiculo_id')|string == v.id|string %}selected{% endif %}>{{ v.nome_conjunto }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="data_inicio" class="form-label">Data de Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ filtros.get('data_inicio', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="data_fim" class="form-label">Data de Fim</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ filtros.get('data_fim', '') }}">
                </div>
                <div class="col-md-2 d-flex">
                    <button type="submit" class="btn btn-primary w-100 me-2">Buscar</button>
                    <button type="button" id="export-pdf-btn" class="btn btn-danger w-100">PDF</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if resultados is not none %}
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">Resultados da Busca</h5>
        </div>
        <div class="card-body">
            {% if resultados %}
                {% for veiculo_nome, datas in resultados.items() %}
                    <h4 class="mt-4 border-bottom pb-2">{{ veiculo_nome }}</h4>
                    {% for data, preenchimentos in datas.items() %}
                        <h5 class="text-muted ms-3 mt-3">{{ data.strftime('%d/%m/%Y') }}</h5>
                        <ul class="list-group ms-3">
                            {% for p in preenchimentos %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>
                                            <strong>{{ p.checklist.codigo }}</strong> ({{ p.checklist.tipo }}) - Preenchido por <strong>{{ p.motorista.nome }}</strong> às {{ p.data_preenchimento.strftime('%H:%M') }}
                                        </span>
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ p.id }}" aria-expanded="false" aria-controls="collapse-{{ p.id }}">
                                            Ver Detalhes
                                        </button>
                                    </div>
                                    <div class="collapse mt-3" id="collapse-{{ p.id }}">
                                        <div class="card card-body">
                                            <h6>Respostas do Checklist:</h6>
                                            <ul class="list-unstyled">
                                                {% for r in p.respostas %}
                                                    <li>
                                                        <strong>{{ r.item.texto }}:</strong> 
                                                        <span class="badge {% if r.resposta == 'CONFORME' %}bg-success{% elif r.resposta == 'NAO CONFORME' %}bg-danger{% else %}bg-secondary{% endif %}">{{ r.resposta }}</span>
                                                        {% if r.observacao %}<small class="text-muted ms-2">- "{{ r.observacao }}"</small>{% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                            <hr>
                                            <h6>Observações Gerais:</h6>
                                            <p><strong>Outros problemas:</strong> {{ p.outros_problemas or 'Nenhum' }}</p>
                                            <p><strong>Soluções adotadas:</strong> {{ p.solucoes_adotadas or 'Nenhuma' }}</p>
                                            <p><strong>Pendências gerais:</strong> {{ p.pendencias_gerais or 'Nenhuma' }}</p>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endfor %}
                {% endfor %}
            {% else %}
                <div class="alert alert-info">Nenhum registro encontrado para os filtros selecionados.</div>
            {% endif %}
        </div>
    </div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const exportButton = document.getElementById('export-pdf-btn');

    if (exportButton) {
        exportButton.addEventListener('click', function() {
            // Pega os valores dos filtros
            const tipoChecklist = document.getElementById('tipo_checklist').value;
            const veiculoId = document.getElementById('veiculo_id').value;
            const dataInicio = document.getElementById('data_inicio').value;
            const dataFim = document.getElementById('data_fim').value;

            // Monta a URL para a rota de geração de PDF
            const url = new URL("{{ url_for('admin.gerar_relatorio_pdf') }}", window.location.origin);
            url.searchParams.set('tipo_checklist', tipoChecklist);
            url.searchParams.set('veiculo_id', veiculoId);
            url.searchParams.set('data_inicio', dataInicio);
            url.searchParams.set('data_fim', dataFim);

            // Redireciona para a URL, o que vai iniciar o download do PDF
            window.location.href = url.toString();
        });
    }
});
</script>
{% endblock %}
