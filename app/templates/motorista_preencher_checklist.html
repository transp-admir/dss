{% extends "base_motorista.html" %}

{% block title %}Preencher Checklist{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-3">Preencher Checklist</h2>

    <div class="card bg-light p-3 mb-4">
        <h4 class="card-title">{{ checklist.tipo }} - {{ checklist.codigo }}</h4>
        <p class="card-text mb-0"><strong>Revisão:</strong> {{ checklist.revisao }}</p>
        <p class="card-text"><strong>Data do Modelo:</strong> {{ checklist.data.strftime('%d/%m/%Y') }}</p>
    </div>

    <form method="POST" action="{{ url_for('main.preencher_checklist', checklist_id=checklist.id) }}">
        
        <div class="card p-3 mb-4 {% if not veiculo %}border-danger{% endif %}">
            <h5 class="card-title">1. Veículo do Checklist</h5>
            {% if veiculo %}
                <p class="card-text mb-1"><strong>Conjunto:</strong> {{ veiculo.nome_conjunto }}</p>
            {% else %}
                <div class="alert alert-danger mb-0">
                    <p><strong>Atenção:</strong> Você não está vinculado a nenhum veículo.</p>
                    <p class="mb-0">Por favor, contate o setor administrativo para que um conjunto seja atribuído a você no sistema.</p>
                </div>
            {% endif %}
        </div>

        <h5 class="mb-3">2. Itens de Verificação</h5>
        
        {% for categoria, itens in itens_agrupados.items() %}
            <div class="accordion mb-3" id="accordion-{{ loop.index }}">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ loop.index }}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="true" aria-controls="collapse-{{ loop.index }}">
                            <strong>{{ categoria.texto }}</strong>
                        </button>
                    </h2>
                    <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse show" aria-labelledby="heading-{{ loop.index }}">
                        <div class="accordion-body">
                            <ul class="list-group">
                                {% for item in itens %}
                                    <li class="list-group-item">
                                        <div class="row align-items-center">
                                            <div class="col-md-4">
                                                <label for="resposta_{{ item.id }}" class="form-label">
                                                    {{ item.texto }}
                                                    {% if item.id in pendencias_abertas %}
                                                        <span class="badge bg-warning text-dark" title="Este item já foi reportado e está pendente de resolução.">⚠️</span>
                                                    {% endif %}
                                                </label>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="btn-group" role="group">
                                                    <input type="radio" class="btn-check" name="resposta-{{ item.id }}" id="conf-{{ item.id }}" value="CONFORME" required>
                                                    <label class="btn btn-outline-success" for="conf-{{ item.id }}">C</label>

                                                    <input type="radio" class="btn-check" name="resposta-{{ item.id }}" id="nconf-{{ item.id }}" value="NAO CONFORME" required>
                                                    <label class="btn btn-outline-danger" for="nconf-{{ item.id }}">NC</label>

                                                    <input type="radio" class="btn-check" name="resposta-{{ item.id }}" id="na-{{ item.id }}" value="N/A" required>
                                                    <label class="btn btn-outline-secondary" for="na-{{ item.id }}">N/A</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="text" name="obs-{{ item.id }}" class="form-control form-control-sm" placeholder="Observação (se necessário)">
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- ========= NOVOS CAMPOS DE TEXTO LIVRE ========= -->
        <h5 class="mt-4 mb-3">3. Observações Gerais</h5>

        <div class="card p-3">
            <div class="mb-3">
                <label for="outros_problemas" class="form-label"><strong>Outros Problemas Encontrados:</strong></label>
                <textarea class="form-control" id="outros_problemas" name="outros_problemas" rows="3" placeholder="Descreva aqui qualquer outro problema que não estava nos itens do checklist."></textarea>
            </div>
            <div class="mb-3">
                <label for="solucoes_adotadas" class="form-label"><strong>Soluções Adotadas na Partida:</strong></label>
                <textarea class="form-control" id="solucoes_adotadas" name="solucoes_adotadas" rows="3" placeholder="Informe aqui quaisquer ações ou soluções que você já tomou para os problemas apontados."></textarea>
            </div>
            <div class="mb-3">
                <label for="pendencias_gerais" class="form-label"><strong>Pendências para a Manutenção:</strong></label>
                <textarea class="form-control" id="pendencias_gerais" name="pendencias_gerais" rows="3" placeholder="Liste aqui os itens gerais que precisam de atenção da equipe de manutenção."></textarea>
            </div>
        </div>
        <!-- =============================================== -->

        <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-primary btn-lg" {% if not veiculo %}disabled{% endif %}>Salvar Checklist</button>
        </div>
    </form>
</div>
{% endblock %}