{% extends "base.html" %}

{% block title %}{{ conteudo.assunto }}{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        /* Estilos do seu template original (mantidos) */
        .recurso-container { margin: 2rem 0; padding: 1.5rem; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; }
        .recurso-container h2 { margin-top: 0; color: #333; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .btn-recurso { display: inline-block; padding: 0.8rem 1.5rem; background-color: #007bff; color: #fff; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .pdf-wrapper { height: 800px; border: 1px solid #ccc; }
        .pdf-wrapper iframe { border: none; }
        .form-opcoes { margin: 2rem 0; }
        .form-opcoes .opcao { margin-bottom: 0.8rem; background-color: #f0f0f0; padding: 1rem; border-radius: 5px; display: block; cursor: pointer; }
        .form-opcoes input[type="radio"] { margin-right: 10px; }

        /* Estilos para o campo de assinatura (adicionado) */
        .signature-pad-container { border: 1px solid #ced4da; border-radius: 5px; position: relative; height: 200px; background-color: white; }
        .signature-pad-container canvas { width: 100%; height: 100%; }
    </style>
{% endblock %}

{% block content %}
<div class="conteudo-body">
    <h1>{{ conteudo.assunto }}</h1>
    <p class="data">Publicado em: {{ conteudo.data.strftime('%d/%m/%Y') }}</p>

    <hr>

    <!-- Bloco para exibir o recurso (seu layout original mantido) -->
    {% if conteudo.recurso_link %}
    <div class="recurso-container">
        <h2>Material de Apoio</h2>
        {% if 'youtube.com' in conteudo.recurso_link or 'youtu.be' in conteudo.recurso_link %}
            <div class="video-wrapper"><iframe src="https://www.youtube.com/embed/{{ conteudo.recurso_link | youtube_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
        {% elif conteudo.tipo_recurso == 'link' %}
            <a href="{{ conteudo.recurso_link }}" target="_blank" class="btn-recurso">Acessar Link</a>
        {% elif conteudo.tipo_recurso == 'arquivo' %}
            {% if conteudo.recurso_link.lower().endswith('.pdf') %}
                <div class="pdf-wrapper"><iframe src="{{ url_for('static', filename=conteudo.recurso_link) }}" width="100%" height="100%"><p>Seu navegador não suporta PDFs. <a href="{{ url_for('static', filename=conteudo.recurso_link) }}">Baixe o arquivo.</a></p></iframe></div>
            {% else %}
                 <img src="{{ url_for('static', filename=conteudo.recurso_link) }}" alt="Recurso do conteúdo" style="max-width: 100%; height: auto;">
            {% endif %}
        {% endif %}
    </div>
    <hr>
    {% endif %}

    <h2>Pergunta / Comunicado:</h2>
    <p>{{ conteudo.pergunta | nl2br }}</p>

    <hr>

    {% if not assinatura %}
    <form method="POST" class="form-assinatura" id="form-leitura">
        <!-- Campos ocultos para tempo e dados da assinatura -->
        <input type="hidden" name="tempo_leitura" id="tempo_leitura">
        <input type="hidden" name="assinatura_imagem" id="assinatura_imagem_input">

        <h2>Opções:</h2>
        <div class="form-opcoes">
            {% if conteudo.respostas %}
                {% for opcao in conteudo.respostas.split(',') %}
                    <label class="opcao"><input type="radio" name="resposta_usuario" value="{{ opcao.strip() }}" required> {{ opcao.strip() }}</label>
                {% endfor %}
            {% else %}
                <p>Não há opções de resposta para este conteúdo.</p>
            {% endif %}
        </div>

        <!-- CAMPO DE ASSINATURA INTEGRADO AO SEU LAYOUT -->
        <h3>Confirmação com Assinatura</h3>
        <p>Eu li, entendi o conteúdo e confirmo minha resposta acima assinando no campo abaixo.</p>
        <div class="signature-pad-container">
            <canvas id="signature-canvas"></canvas>
        </div>
        <div style="text-align: right; margin-top: 5px;">
            <button type="button" id="clear-signature" class="btn btn-sm btn-outline-secondary">Limpar</button>
        </div>

        <button type="submit" class="btn-assinar" style="margin-top: 20px; width: 100%;">Assinar e Confirmar Leitura</button>
    </form>
    {% else %}
        <!-- Layout para quando já foi assinado -->
        <div class="form-assinatura">
            <h3>Leitura Confirmada</h3>
            <p>Você assinou este conteúdo em {{ assinatura.data_assinatura.strftime('%d/%m/%Y às %H:%M') }}.</p>
            <p><strong>Sua resposta:</strong> {{ assinatura.resposta_motorista }}</p>
            {% if assinatura.assinatura_imagem %}
                <div style="margin-top: 1rem; text-align: center;">
                    <strong>Sua assinatura:</strong><br>
                    <img src="{{ assinatura.assinatura_imagem }}" alt="Sua Assinatura" style="height: 60px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                </div>
            {% endif %}
            <button class="btn-assinado" disabled>Assinado</button>
        </div>
    {% endif %}

    <a href="{{ url_for('main.lista_conteudos') }}" style="display: inline-block; margin-top: 2rem;">Voltar para a Lista</a>
</div>

<!-- Scripts -->
{% if not assinatura %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('form-leitura');
        if (form) {
            // Registra o tempo inicial
            const startTime = Date.now();

            // Configuração do Signature Pad
            const canvas = document.getElementById('signature-canvas');
            const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

            function resizeCanvas() {
                const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();

            document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());

            // Validação no envio do formulário
            form.addEventListener('submit', function(event) {
                // 1. Validar se uma resposta foi selecionada
                const respostaSelecionada = form.querySelector('input[name="resposta_usuario"]:checked');
                if (!respostaSelecionada) {
                    alert("Por favor, selecione uma das respostas.");
                    event.preventDefault();
                    return;
                }

                // 2. Validar se o campo de assinatura não está vazio
                if (signaturePad.isEmpty()) {
                    alert("Por favor, assine no campo indicado para confirmar.");
                    event.preventDefault();
                    return;
                }

                // 3. Se tudo estiver OK, preencher os campos ocultos antes de enviar
                const durationInSeconds = Math.round((Date.now() - startTime) / 1000);
                document.getElementById('tempo_leitura').value = durationInSeconds;
                document.getElementById('assinatura_imagem_input').value = signaturePad.toDataURL('image/png');
            });
        }
    });
</script>
{% endif %}
{% endblock %}
