{% extends "base_adm.html" %}

{% block title %}Gerenciar Itens do Checklist - {{ checklist.codigo }}{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/conteudo.css') }}">
    <style>
        .accordion-button:not(.collapsed) {
            color: #fff;
            background-color: #005A9C;
        }
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 90, 156, 0.5);
        }
        .sub-item-form {
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .item-list {
            list-style-type: none;
            padding-left: 0;
        }
        .item-list li {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #eee;
        }
        .item-text {
            flex-grow: 1;
            margin-left: 1rem;
        }
    </style>
{% endblock %}

{% block header %}
    Gerenciar Itens do Checklist: {{ checklist.codigo }}
{% endblock %}

{% block content %}

{# 1. Card para ADICIONAR ITEM PRINCIPAL (CATEGORIA) #}
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-plus-circle me-1"></i>
        Adicionar Nova Categoria (Item Principal)
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.checklist_detalhe', checklist_id=checklist.id) }}" class="row g-3 align-items-end">
            <div class="col-md-8">
                <label for="texto_principal" class="form-label">Nome da Categoria</label>
                <input type="text" id="texto_principal" name="texto" class="form-control" placeholder="Ex: Documentação, Segurança do Veículo..." required>
            </div>
            <div class="col-md-2">
                <label for="ordem_principal" class="form-label">Ordem</label>
                <input type="number" id="ordem_principal" name="ordem" class="form-control" value="0" min="0">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Adicionar Categoria</button>
            </div>
        </form>
    </div>
</div>

{# 2. Listagem dos Itens Principais e seus Sub-itens em formato de Acordeão #}
<h3 class="mb-3">Categorias e Itens do Checklist</h3>
<div class="accordion" id="accordionChecklistItens">
    {% for item_principal in itens_principais %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading-{{ item_principal.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ item_principal.id }}" aria-expanded="false" aria-controls="collapse-{{ item_principal.id }}">
                    <span class="me-auto"><strong>{{ item_principal.ordem }}. {{ item_principal.texto }}</strong></span>
                    <span class="badge bg-primary me-3">{{ item_principal.sub_itens.count() }} sub-itens</span>
                </button>
            </h2>
            <div id="collapse-{{ item_principal.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ item_principal.id }}" data-bs-parent="#accordionChecklistItens">
                <div class="accordion-body">
                    
                    {# Ações para o item principal #}
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editItemModal" 
                                data-item-id="{{ item_principal.id }}"
                                data-item-texto="{{ item_principal.texto }}"
                                data-item-ordem="{{ item_principal.ordem }}">
                            <i class="fas fa-edit"></i> Editar Categoria
                        </button>
                        <form method="POST" action="{{ url_for('admin.excluir_item', item_id=item_principal.id) }}" onsubmit="return confirm('Tem certeza que quer excluir esta CATEGORIA e todos os seus sub-itens?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i> Excluir Categoria</button>
                        </form>
                    </div>

                    {# Listagem de Sub-itens existentes #}
                    <h5><i class="fas fa-list-ul me-1"></i> Itens de Verificação</h5>
                    {% if item_principal.sub_itens.all() %}
                        <ul class="item-list mb-4">
                            {% for sub_item in item_principal.sub_itens.order_by(ChecklistItem.ordem) %}
                                <li>
                                    <span>{{ sub_item.ordem }}.</span>
                                    <span class="item-text">{{ sub_item.texto }}</span>
                                    <div>
                                        <button class="btn btn-sm btn-secondary me-1" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editItemModal" 
                                                data-item-id="{{ sub_item.id }}"
                                                data-item-texto="{{ sub_item.texto }}"
                                                data-item-ordem="{{ sub_item.ordem }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form method="POST" action="{{ url_for('admin.excluir_item', item_id=sub_item.id) }}" style="display: inline;" onsubmit="return confirm('Excluir este item de verificação?');">
                                            <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                        </form>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted fst-italic">Nenhum item de verificação cadastrado nesta categoria ainda.</p>
                    {% endif %}

                    {# Formulário para adicionar NOVO SUB-ITEM #}
                    <div class="sub-item-form">
                         <h5><i class="fas fa-plus me-1"></i> Adicionar Novo Item de Verificação</h5>
                        <form method="POST" action="{{ url_for('admin.checklist_detalhe', checklist_id=checklist.id) }}">
                            <input type="hidden" name="parent_id" value="{{ item_principal.id }}">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-8">
                                    <label for="texto-sub-{{ item_principal.id }}" class="form-label">Texto da Pergunta</label>
                                    <input type="text" id="texto-sub-{{ item_principal.id }}" name="texto" class="form-control form-control-sm" placeholder="Ex: Verificar validade da CNH" required>
                                </div>
                                <div class="col-md-2">
                                    <label for="ordem-sub-{{ item_principal.id }}" class="form-label">Ordem</label>
                                    <input type="number" id="ordem-sub-{{ item_principal.id }}" name="ordem" class="form-control form-control-sm" value="0" min="0">
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success btn-sm w-100">Adicionar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card card-body text-center">
            <p class="mb-0">Nenhuma categoria cadastrada. Use o formulário acima para criar a primeira.</p>
        </div>
    {% endfor %}
</div>

<div class="mt-4">
    <a href="{{ url_for('admin.gerenciar_checklists') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar para a lista de checklists</a>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editItemModalLabel">Editar Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editItemForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editItemTexto" class="form-label">Texto do Item</label>
            <input type="text" class="form-control" id="editItemTexto" name="texto" required>
          </div>
          <div class="mb-3">
            <label for="editItemOrdem" class="form-label">Ordem</label>
            <input type="number" class="form-control" id="editItemOrdem" name="ordem" required min="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    var editItemModal = document.getElementById('editItemModal');
    editItemModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var itemId = button.getAttribute('data-item-id');
        var itemTexto = button.getAttribute('data-item-texto');
        var itemOrdem = button.getAttribute('data-item-ordem');

        var modalForm = editItemModal.querySelector('#editItemForm');
        var modalInputTexto = editItemModal.querySelector('#editItemTexto');
        var modalInputOrdem = editItemModal.querySelector('#editItemOrdem');

        modalForm.action = `/admin/checklist/item/${itemId}/editar`;
        modalInputTexto.value = itemTexto;
        modalInputOrdem.value = itemOrdem;
    });

    var editForm = document.getElementById('editItemForm');
    editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        var form = e.target;
        var url = form.action;
        var formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fecha o modal e recarrega a página para ver a mensagem flash e a atualização.
                var modal = bootstrap.Modal.getInstance(editItemModal);
                modal.hide();
                location.reload();
            } else {
                alert(data.message || 'Ocorreu um erro ao atualizar o item.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocorreu um erro de comunicação com o servidor.');
        });
    });
});
</script>
{% endblock %}
